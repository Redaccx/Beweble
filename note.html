
<!DOCTYPE html>
<html>
<head>
	<title>Home</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="note.css">
	<link rel="stylesheet" type="text/css" href="login.html">
	<link rel="stylesheet" type="text/css" href="signup.html">
	<link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js">
	<link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://cdn.ckeditor.com/4.16.1/standard-all/ckeditor.js"></script>
  
</head>
<body class="mainbody2">

    <nav class="navbar sticky-top navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="#">THE NOTES APP</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
                <li class="nav-item active">
                   <a button type="button" class="nav-link btn btn-light" href="about.html">About<span class="sr-only">(current)</span></a>
                </li>
                <li class="nav-item active">
                   <a button type="button" class="nav-link btn btn-light" id="signout">LogOut<span class="sr-only">(current)</span></a>
                </li>

            </ul>
            <form class="form-inline my-2 my-lg-0">
                <input class="form-control mr-sm-2" id="searchTxt" type="search" placeholder="Search Title" aria-label="Search">
                <button class="btn btn-outline-success my-2 my-sm-0" type="submit">Search</button>
            </form>
        </div>
    </nav>


    <div class="container my-3" id="form">
        <h1 id="Heading">Welcome To THE NOTES APP</h1>
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Add a Note</h5>
                <div class="form-group">
                    <textarea class="form-control" id="addTitle" rows="1" placeholder="Title Here!!"></textarea>
                    <br>
                    <textarea class="form-control" id="addTxt" rows="10" placeholder="Type Here!!"></textarea>
                </div>
                <button class="btn btn-success" id="addBtn">Add Note</button>
                <button class="btn btn-danger" id="clearAll">Clear All</button>
            </div>
        </div>
        <hr>
        <h1 id="Heading">Your Notes</h1>
        <hr>
        <div id="notes" class="row container-fluid"> </div>
    </div>


    <footer class="footer  bg-light py-3" style="background-color: #F8F9FA;">
        <div class="container">
            <span class="text-muted">&copy THE NOTESAPP</span>
        </div>
      </footer>



    <script>
        CKEDITOR.replace('addTxt', {
          extraPlugins: 'editorplaceholder',
          editorplaceholder: 'Start typing here...',
          uiColor:'#F8F9FA'
        });
      </script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.5/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.2.5/firebase-database.js"></script>
    <script>
var firebaseConfig = {
    apiKey: "AIzaSyAFPHSQdRugV6ngWGtPuUfSzBhS94D30hU",
    authDomain: "reda-7d506.firebaseapp.com",
    projectId: "reda-7d506",
    storageBucket: "reda-7d506.appspot.com",
    messagingSenderId: "637395019512",
    appId: "1:637395019512:web:1c7834e529eb90dcaf3d0d"
};
// Initialize Firebase
firebase.initializeApp(firebaseConfig);
firebase.analytics();
const dbRef = firebase.database()
const auth = firebase.auth();


let fsignout = 0;
let flagEdit = 0;
var editIndex = -1;
//Authentication function to check if any user is logged in
firebase.auth().onAuthStateChanged(function (user) {


    if (user) {
        console.log("Welcome to notes app. This is app.js");
        getNotesForThisUser().then(notes => display(notes)).catch(err => handleError(err))

    } else if (fsignout == 0) {
        window.alert("You need to LogIn First.Redirecting to Home Page.");
        window.location = "index.html";
    }
});

//dipslay



//Clears the contents
let addBtn = document.getElementById("addBtn");
let clearBtn = document.getElementById("clearAll")
clearBtn.addEventListener("click", e => {
    window.location.reload();
})

// If user adds a note, add it to the Firebase
addBtn.addEventListener("click", function (e) {
    document.getElementById("addTxt").value = CKEDITOR.instances["addTxt"].getData(); //getting data from editor
    if (document.getElementById("addTxt").value != "" && document.getElementById("addTitle").value != "" && flagEdit === 0) {
        saveNoteWithTitle(document.getElementById("addTitle").value, document.getElementById("addTxt").value)
            .then(async res => {
                let notes = await getNotesForThisUser()
                display(notes)
                document.getElementById("addTxt").value = "";
                document.getElementById("addTitle").value = "";
                CKEDITOR.instances["addTxt"].setData('');
            })
            .catch(err => console.log(err))
    } else if (flagEdit === 1) {

        if (document.getElementById("addTxt").value != "" && document.getElementById("addTitle").value != "") {
            updateNote(localStorage.getItem("uid"), editIndex, document.getElementById("addTxt").value, document.getElementById("addTitle").value);
            getNotesForThisUser().then(notes => display(notes)).catch(err => handleError(err));
        }
        else {
            if (document.getElementById("addTitle").value == "")
                window.alert("Warning: Empty Note Title")
            else
                window.alert("Warning: Empty Note Content")
        }
        document.getElementById("addTxt").value = '';
        document.getElementById("addTitle").value = '';
        CKEDITOR.instances["addTxt"].setData('');
        flagEdit = 0;
        editIndex = -1;

        replaceButtonText('addBtn', 'Add Note');
    }
    else {
        if (document.getElementById("addTitle").value == "")
            window.alert("Warning: Empty Note Title")
        else
            window.alert("Warning: Empty Note Content")
    }
});




// Function to show elements from Firebase
function display(notes) {
    let i = 1;
    let html = "";
    Object.keys(notes).forEach(function (k, i) {
        if (notes[k].title != undefined) {
            html += `
                <div class="noteCard my-2 mx-2 card" content="centre" style="width:100%;" >
                        <div class="card-body" id="note-card">
                            <h5 class="card-title">${notes[k].title}</h5>
                            <p class="card-text" > ${notes[k].content}</p>
                            <button id="${k}" onclick="deleteNote(this.id)" class="btn btn-danger">Delete Note</button>
                            <button id="${k}" onclick="editNote(this.id)" class="btn btn-info">Edit Note</button>
                        </div>
                            <div class="card-footer text-muted" style="font: italics;">
                            Last Updated: ${notes[k].lastUpdated}
                        </div>
                    </div>`;
        }
        else {
            html += `
                <div class="noteCard my-2 mx-2 card" content="centre" style="width:100%;" >
                        <div class="card-body" id="note-card">
                            <h5 class="card-title">Note ${i + 1} (You can Now edit Title)</h5>
                            <p class="card-text" > ${notes[k]}</p>
                            <button id="${k}" onclick="deleteNote(this.id)" class="btn btn-danger">Delete Note</button>
                            <button id="${k}" onclick="editNote(this.id)" class="btn btn-info">Edit Note</button>
                        </div>
                    </div>`;
        }
        i++
    });
    let notesElm = document.getElementById("notes");
    if (i > 0)
        notesElm.innerHTML = html;
    else
        notesElm.innerHTML = `Nothing to show! Use "Add a Note" section above to add notes.`;
    return;
}

//function to write data
function updateNote(userId, noteId, newBody, newTitle) {
    var d = new Date(Date.now())
    var lastUpdated = d.getDate() + '.' + (d.getMonth() + 1) + '.' + d.getFullYear() + ',' + d.getHours() + ':' + d.getMinutes();
    let updates = {
        ['/notes/' + userId + '/' + noteId + '/content']: newBody,
        ['/notes/' + userId + '/' + noteId + '/title']: newTitle,
        ['/notes/' + userId + '/' + noteId + '/lastUpdated']: lastUpdated
    }
    return firebase.database().ref().update(updates, (e) => {
        if (e) console.log(e)
    })
}

//Function to edit a note
function editNote(index) {
    const uid = localStorage.getItem("uid")
    window.scrollTo(0, 0);
    var adaRef = firebase.database().ref('notes/' + uid + '/' + index);
    adaRef.get().then((snapshot) => {
        if (snapshot.exists()) {
            var crrntNote = snapshot.val();
            document.getElementById("addTitle").value = crrntNote.title;
            document.getElementById("addTxt").value = crrntNote.content;
            CKEDITOR.instances["addTxt"].setData(crrntNote);
            replaceButtonText('addBtn', 'Update Note');
            flagEdit = 1;
            editIndex = index;

        }
    }).catch((error) => {
        console.error(error);
    });
}

// Function to delete a note
function deleteNote(index) {
    const uid = localStorage.getItem("uid")
    var adaRef = firebase.database().ref('notes/' + uid + '/' + index);
    adaRef.remove()
        .then(function () {
            getNotesForThisUser().then(notes => display(notes)).catch(err => handleError(err))
            CKEDITOR.instances["addTxt"].setData('');
        })
        .catch(function (error) {
            console.log("Remove failed: " + error.message)
        });



}



function replaceButtonText(buttonId, text) {
    if (document.getElementById) {
        var button = document.getElementById(buttonId);
        if (button) {
            if (button.childNodes[0]) {
                button.childNodes[0].nodeValue = text;
            }
            else if (button.value) {
                button.value = text;
            }
            else //if (button.innerHTML)
            {
                button.innerHTML = text;
            }
        }
    }
}


let search = document.getElementById('searchTxt');
search.addEventListener("input", function () {

    let inputVal = search.value.toLowerCase();
    // console.log('Input event fired!', inputVal);
    let noteCards = document.getElementsByClassName('noteCard');
    Array.from(noteCards).forEach(function (element) {
        let cardTxt = element.getElementsByClassName("card-title")[0].innerText;
        if (cardTxt.toLowerCase().includes(inputVal)) {
            element.style.display = "block";
        } else {
            element.style.display = "none";
        }
        // console.log(cardTxt);
    })
})
//Saving Note with title
async function saveNoteWithTitle(title, content) {
    const uid = localStorage.getItem("uid")
    var d = new Date(Date.now())
    var lastUpdated = d.getDate() + '.' + (d.getMonth() + 1) + '.' + d.getFullYear() + ',' + d.getHours() + ':' + d.getMinutes();
    const userNoteRef = dbRef.ref('notes/' + uid)
    let upd =
    {
        title,
        content,
        lastUpdated
    }
    return await userNoteRef.update({

        [Date.now()]: upd
    })

}
/*
async function saveNoteToFirebase(content) {
    const uid = localStorage.getItem("uid")
    //window.alert("Successfully Added");
    const userNoteRef = dbRef.ref('notes/' + uid)
    let notes = await getNotesForThisUser()
    return await userNoteRef.set({
        ...notes,
        [Date.now()]: content
    })
}*/

async function getNotesForThisUser() {
    const uid = localStorage.getItem("uid")
    const userNotesRef = dbRef.ref('notes/' + uid)
    const ss = await userNotesRef.get()
    if (ss.exists())
        return ss.val()
    else {
        let notesElm = document.getElementById("notes");
        notesElm.innerHTML = `Nothing to show! Use "Add a Note" section above to add notes.`;
        return;
    }

}
//LogOut Function
document.querySelector('#signout').addEventListener('click', function () {
    auth.signOut()
        .then(() => {
            // Sign-out successful.
            window.alert("You have Logged Out Succesfully.");
            window.location = "index.html";
            fsignout = 1;
        }).catch((error) => {
            // An error happened.
            alert(error.message);
        });
});


/*
TODO: Further Features:
1. Add Title
2. Mark a note as Important
3. Separate notes by user
4. Sync and host to web server
*/
</script>
    
</body>

</html>
